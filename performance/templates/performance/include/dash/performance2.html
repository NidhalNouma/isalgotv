{% load custom_tags %}
{% load custom_filters %}

{% if perf_emsg %}
  <section class="w-full mt-4">
    {% include 'include/infos.html' with info=perf_emsg %}
  </section>
{% else %}

  {# ===== HERO SECTION - Main Stats with Visual Impact ===== #}
  <section class="mt-4 w-full">
    <div class="relative overflow-hidden rounded-2xl bg-gradient-to-br from-primary/10 via-background to-profit/5 border border-text/10 p-6">
      {# Background decoration #}
      <div class="absolute top-0 right-0 w-64 h-64 bg-primary/5 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2"></div>
      <div class="absolute bottom-0 left-0 w-48 h-48 bg-profit/5 rounded-full blur-3xl translate-y-1/2 -translate-x-1/2"></div>
      
      <div class="relative grid grid-cols-1 lg:grid-cols-3 gap-6">
        {# Left: Win Rate Donut Chart #}
        <div class="flex flex-col items-center justify-center">
          <div class="relative w-40 h-40">
            <canvas id="winRateDonut-{{ cid }}"></canvas>
            <div class="absolute inset-0 flex flex-col items-center justify-center">
              <span class="text-3xl font-bold text-title">{{ overview_data.win_rate|default:'0' }}%</span>
              <span class="text-xs text-text/50">Win Rate</span>
            </div>
          </div>
          <div class="flex gap-4 mt-3 text-xs">
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-profit"></span> {{ overview_data.winning_trades }} Wins</span>
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-loss"></span> {{ overview_data.losing_trades }} Losses</span>
          </div>
        </div>
        
        {# Center: Key Metrics #}
        <div class="flex flex-col justify-center space-y-4">
          <div class="text-center lg:text-left">
            <h2 class="text-4xl font-bold text-title">{{ overview_data.trades|default:'0' }}</h2>
            <p class="text-sm text-text/60">Total Trades Executed</p>
          </div>
          <div class="grid grid-cols-2 gap-3">
            <div class="bg-text/5 rounded-xl p-3 text-center">
              <span class="text-2xl font-bold text-primary">{{ overview_data.buy_trades|default:'0' }}</span>
              <p class="text-xs text-text/50 mt-1">↑ Buy Orders</p>
            </div>
            <div class="bg-text/5 rounded-xl p-3 text-center">
              <span class="text-2xl font-bold text-text/70">{{ overview_data.sell_trades|default:'0' }}</span>
              <p class="text-xs text-text/50 mt-1">↓ Sell Orders</p>
            </div>
          </div>
        </div>
        
        {# Right: Buy/Sell Pie Chart #}
        <div class="flex flex-col items-center justify-center">
          <div class="relative w-40 h-40">
            <canvas id="buySellPie-{{ cid }}"></canvas>
          </div>
          <p class="text-xs text-text/50 mt-3">Buy vs Sell Distribution</p>
        </div>
      </div>
    </div>
  </section>

  {# ===== PERFORMANCE GAUGES ===== #}
  <section class="mt-6 grid grid-cols-2 lg:grid-cols-4 gap-4">
    {# Buy Win Rate Gauge #}
    <div class="bg-text/5 rounded-xl p-4 text-center border border-text/5">
      <div class="relative w-24 h-12 mx-auto overflow-hidden">
        <div class="absolute inset-0 border-[8px] border-text/10 rounded-t-full border-b-0"></div>
        <div class="absolute inset-0 border-[8px] border-primary rounded-t-full border-b-0 origin-bottom" 
             style="transform: rotate({{ overview_data.buy_win_rate|default:0 }}deg); clip-path: inset(0 50% 0 0);"></div>
        <div class="absolute inset-0 border-[8px] border-primary rounded-t-full border-b-0 origin-bottom" 
             style="transform: rotate({{ overview_data.buy_win_rate|default:0|add:-180 }}deg); clip-path: inset(0 0 0 50%);"></div>
      </div>
      <span class="text-2xl font-bold text-primary block mt-2">{{ overview_data.buy_win_rate|default:'0' }}%</span>
      <span class="text-xs text-text/50">Buy Win Rate</span>
    </div>
    
    {# Sell Win Rate Gauge #}
    <div class="bg-text/5 rounded-xl p-4 text-center border border-text/5">
      <div class="relative w-24 h-12 mx-auto overflow-hidden">
        <div class="absolute inset-0 border-[8px] border-text/10 rounded-t-full border-b-0"></div>
      </div>
      <span class="text-2xl font-bold text-text/70 block mt-2">{{ overview_data.sell_win_rate|default:'0' }}%</span>
      <span class="text-xs text-text/50">Sell Win Rate</span>
    </div>
    
    {# Best Streak #}
    <div class="bg-gradient-to-br from-profit/10 to-transparent rounded-xl p-4 text-center border border-profit/20">
      <div class="w-12 h-12 mx-auto rounded-full bg-profit/20 flex items-center justify-center mb-2">
        <svg class="w-6 h-6 text-profit" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/>
        </svg>
      </div>
      <span class="text-2xl font-bold text-profit block">{{ overview_data.winning_trades|default:'0' }}</span>
      <span class="text-xs text-text/50">Winning Trades</span>
    </div>
    
    {# Loss Count #}
    <div class="bg-gradient-to-br from-loss/10 to-transparent rounded-xl p-4 text-center border border-loss/20">
      <div class="w-12 h-12 mx-auto rounded-full bg-loss/20 flex items-center justify-center mb-2">
        <svg class="w-6 h-6 text-loss" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="10"/>
          <path d="M15 9l-6 6M9 9l6 6"/>
        </svg>
      </div>
      <span class="text-2xl font-bold text-loss block">{{ overview_data.losing_trades|default:'0' }}</span>
      <span class="text-xs text-text/50">Losing Trades</span>
    </div>
  </section>

  {# ===== BUY VS SELL RADAR COMPARISON ===== #}
  <section class="mt-6 grid grid-cols-1 lg:grid-cols-2 gap-4">
    {# Buy Performance #}
    <div class="bg-text/5 rounded-xl p-5 border border-primary/20">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 rounded-xl bg-primary/20 flex items-center justify-center">
          <svg class="w-5 h-5 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 19V5M5 12l7-7 7 7"/>
          </svg>
        </div>
        <div>
          <h4 class="font-semibold text-title">Buy Performance</h4>
          <p class="text-xs text-text/50">{{ overview_data.buy_trades }} total trades</p>
        </div>
        <span class="ml-auto text-2xl font-bold text-primary">{{ overview_data.buy_win_rate }}%</span>
      </div>
      
      <div class="space-y-3">
        <div>
          <div class="flex justify-between text-xs mb-1">
            <span class="text-text/60">Win Rate Progress</span>
            <span class="text-profit font-medium">{{ overview_data.buy_winning_trades }}/{{ overview_data.buy_trades }}</span>
          </div>
          <div class="h-3 rounded-full bg-text/10 overflow-hidden">
            <div class="h-full bg-gradient-to-r from-primary to-profit rounded-full transition-all" style="width: {{ overview_data.buy_win_rate }}%"></div>
          </div>
        </div>
        
        <div class="grid grid-cols-3 gap-2 pt-2">
          <div class="text-center p-2 bg-text/5 rounded-lg">
            <span class="text-lg font-bold text-profit">{{ overview_data.buy_winning_trades }}</span>
            <p class="text-[10px] text-text/50">Winners</p>
          </div>
          <div class="text-center p-2 bg-text/5 rounded-lg">
            <span class="text-lg font-bold text-loss">{{ overview_data.buy_losing_trades }}</span>
            <p class="text-[10px] text-text/50">Losers</p>
          </div>
          <div class="text-center p-2 bg-text/5 rounded-lg">
            <span class="text-lg font-bold text-text/70">{{ overview_data.buy_win_rate|differance:100|floatformat:0 }}%</span>
            <p class="text-[10px] text-text/50">Loss Rate</p>
          </div>
        </div>
      </div>
    </div>
    
    {# Sell Performance #}
    <div class="bg-text/5 rounded-xl p-5 border border-text/10">
      <div class="flex items-center gap-3 mb-4">
        <div class="w-10 h-10 rounded-xl bg-text/10 flex items-center justify-center">
          <svg class="w-5 h-5 text-text/60" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M12 5v14M5 12l7 7 7-7"/>
          </svg>
        </div>
        <div>
          <h4 class="font-semibold text-title">Sell Performance</h4>
          <p class="text-xs text-text/50">{{ overview_data.sell_trades }} total trades</p>
        </div>
        <span class="ml-auto text-2xl font-bold text-text/70">{{ overview_data.sell_win_rate }}%</span>
      </div>
      
      <div class="space-y-3">
        <div>
          <div class="flex justify-between text-xs mb-1">
            <span class="text-text/60">Win Rate Progress</span>
            <span class="text-profit font-medium">{{ overview_data.sell_winning_trades }}/{{ overview_data.sell_trades }}</span>
          </div>
          <div class="h-3 rounded-full bg-text/10 overflow-hidden">
            <div class="h-full bg-gradient-to-r from-text/40 to-text/60 rounded-full transition-all" style="width: {{ overview_data.sell_win_rate }}%"></div>
          </div>
        </div>
        
        <div class="grid grid-cols-3 gap-2 pt-2">
          <div class="text-center p-2 bg-text/5 rounded-lg">
            <span class="text-lg font-bold text-profit">{{ overview_data.sell_winning_trades }}</span>
            <p class="text-[10px] text-text/50">Winners</p>
          </div>
          <div class="text-center p-2 bg-text/5 rounded-lg">
            <span class="text-lg font-bold text-loss">{{ overview_data.sell_losing_trades }}</span>
            <p class="text-[10px] text-text/50">Losers</p>
          </div>
          <div class="text-center p-2 bg-text/5 rounded-lg">
            <span class="text-lg font-bold text-text/70">{{ overview_data.sell_win_rate|differance:100|floatformat:0 }}%</span>
            <p class="text-[10px] text-text/50">Loss Rate</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  {# ===== CURRENCY PERFORMANCE CARDS ===== #}
  {% if currencies_performance %}
    <section class="mt-6">
      <div class="flex items-center justify-between mb-4">
        <h4 class="text-base font-semibold text-title/80">Currency Breakdown</h4>
        <span class="text-xs text-text/50">{{ currencies_performance|length }} currencies</span>
      </div>
      
      <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
        {% for currency, perf in currencies_performance.items %}
          <div class="group relative bg-text/5 rounded-xl p-4 border border-text/10 hover:border-primary/30 transition-all">
            {# Header #}
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-2">
                <div class="w-8 h-8 rounded-lg bg-primary/20 flex items-center justify-center text-sm font-bold text-primary">
                  {{ currency|slice:":2" }}
                </div>
                <span class="font-semibold text-title">{{ currency }}</span>
              </div>
              <span class="text-lg font-bold {% if perf.net_profit >= 0 %}text-profit{% else %}text-loss{% endif %}">
                {% if perf.net_profit >= 0 %}+{% endif %}{{ perf.net_profit|floatformat:2|trim_zeros }}
              </span>
            </div>
            
            {# Mini Chart Area #}
            <div class="h-16 mb-3 relative">
              <canvas id="currencyMini-{{ currency }}-{{ cid }}" class="w-full h-full"></canvas>
            </div>
            
            {# Stats Grid #}
            <div class="grid grid-cols-4 gap-1 text-center text-xs">
              <div class="p-1.5 bg-text/5 rounded">
                <span class="font-bold text-text/80 block">{{ perf.trades }}</span>
                <span class="text-text/40 text-[10px]">Trades</span>
              </div>
              <div class="p-1.5 bg-text/5 rounded">
                <span class="font-bold text-profit block">{{ perf.profit_factor|floatformat:1 }}</span>
                <span class="text-text/40 text-[10px]">PF</span>
              </div>
              <div class="p-1.5 bg-text/5 rounded">
                <span class="font-bold text-profit block">+{{ perf.gross_profit|floatformat:1|trim_zeros }}</span>
                <span class="text-text/40 text-[10px]">Gross+</span>
              </div>
              <div class="p-1.5 bg-text/5 rounded">
                <span class="font-bold text-loss block">{{ perf.gross_loss|floatformat:1|trim_zeros }}</span>
                <span class="text-text/40 text-[10px]">Gross-</span>
              </div>
            </div>
          </div>
        {% endfor %}
      </div>
    </section>
  {% endif %}

  {# ===== DAILY PERFORMANCE CHART ===== #}
  {% if chart_data %}
    <section class="mt-6 bg-text/5 rounded-xl p-5 border border-text/10">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
        <h4 class="text-base font-semibold text-title/80">Equity Curve</h4>
        
        {# Currency Pills #}
        <div id="currency-tabs-{{ cid }}" class="flex flex-wrap gap-2">
          {% for currency, info in chart_data.items %}
            <button 
              data-currency="{{ currency }}" 
              data-cid="{{ cid }}"
              data-chart-data='{{ info.data|to_json }}'
              data-profit="{{ info.cumulative.net_profit }}"
              class="currency-tab-{{ cid }} px-3 py-1 text-xs font-medium rounded-full transition-all
                {% if forloop.first %}bg-primary text-white{% else %}bg-text/10 text-text/60 hover:bg-text/20{% endif %}"
            >
              {{ currency }}
            </button>
          {% endfor %}
        </div>
      </div>
      
      {# Stats Bar #}
      {% for currency, info in chart_data.items %}
        <div id="chart-stats-{{ currency }}-{{ cid }}" class="chart-stats-{{ cid }} {% if not forloop.first %}hidden{% endif %} flex flex-wrap gap-6 mb-4 pb-4 border-b border-text/10">
          <div>
            <span class="text-xs text-text/50 block">Net P/L</span>
            <span class="text-xl font-bold {% if info.cumulative.net_profit >= 0 %}text-profit{% else %}text-loss{% endif %}">
              {% if info.cumulative.net_profit >= 0 %}+{% endif %}{{ info.cumulative.net_profit|floatformat:4|trim_zeros }}
            </span>
          </div>
          <div>
            <span class="text-xs text-text/50 block">Peak</span>
            <span class="text-xl font-bold text-profit">{{ info.max_net_profit|floatformat:4|trim_zeros }}</span>
          </div>
          <div>
            <span class="text-xs text-text/50 block">Drawdown</span>
            <span class="text-xl font-bold text-loss">{{ info.max_drawdown|floatformat:4|trim_zeros }}</span>
          </div>
          <div>
            <span class="text-xs text-text/50 block">Days</span>
            <span class="text-xl font-bold text-text/80">{{ info.number_of_days|default:'0' }}</span>
          </div>
          <div>
            <span class="text-xs text-text/50 block">Avg/Day</span>
            <span class="text-xl font-bold {% if info.avg_daily_net_profit >= 0 %}text-profit{% else %}text-loss{% endif %}">
              {{ info.avg_daily_net_profit|floatformat:2|trim_zeros|default:'0' }}
            </span>
          </div>
        </div>
      {% endfor %}
      
      {# Chart #}
      <div class="relative w-full h-64 sm:h-80">
        <canvas id="perfChart2-{{ id }}-{{ cid }}" class="!w-full !h-full"></canvas>
      </div>
    </section>
  {% endif %}

  {# ===== RELATED STRATEGIES/ASSETS CAROUSEL ===== #}
  {% if strategies %}
    <section class="mt-6">
      <h4 class="text-base font-semibold text-title/80 mb-4">Related Strategies</h4>
      <div class="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
        {% for strategy, info in strategies.items %}
          {% url 'strategy_performance' strategy_id=strategy.id perf_id=perf_id as strategy_url %}
          <a href="{{ strategy_url }}" class="flex-shrink-0 w-48 bg-text/5 hover:bg-text/10 rounded-xl p-4 border border-text/10 transition-all">
            <div class="w-10 h-10 rounded-lg bg-primary/20 flex items-center justify-center mb-3">
              <svg class="w-5 h-5 text-primary" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z"/>
                <line x1="4" y1="22" x2="4" y2="15"/>
              </svg>
            </div>
            <h5 class="font-medium text-title truncate">{{ strategy.name }}</h5>
            <div class="flex items-center justify-between mt-2 text-xs">
              <span class="text-text/50">{{ info.trades }} trades</span>
              <span class="text-profit font-medium">{{ info.win_rate }}%</span>
            </div>
          </a>
        {% endfor %}
      </div>
    </section>
  {% endif %}
  
  {% if assets %}
    <section class="mt-6">
      <h4 class="text-base font-semibold text-title/80 mb-4">Traded Assets</h4>
      <div class="flex gap-3 overflow-x-auto pb-2 no-scrollbar">
        {% for asset, info in assets.items %}
          {% url 'asset_performance' asset=asset perf_id=perf_id as asset_url %}
          <a href="{{ asset_url }}" class="flex-shrink-0 w-44 bg-text/5 hover:bg-text/10 rounded-xl p-4 border border-text/10 transition-all">
            <h5 class="font-bold text-title text-lg">{{ asset }}</h5>
            <div class="flex items-center justify-between mt-2 text-xs">
              <span class="text-text/50">{{ info.trades }} trades</span>
              <span class="text-profit font-medium">{{ info.win_rate }}%</span>
            </div>
            <div class="mt-2 h-1.5 rounded-full bg-text/10 overflow-hidden">
              <div class="h-full bg-profit" style="width: {{ info.win_rate }}%"></div>
            </div>
          </a>
        {% endfor %}
      </div>
    </section>
  {% endif %}

  {# ===== RECENT TRADES TABLE ===== #}
  {% if trades|length > 0 %}
    <section class="mt-6 bg-text/5 rounded-xl border border-text/10 overflow-hidden">
      <div class="p-4 border-b border-text/10">
        <h4 class="text-base font-semibold text-title/80">Recent Trades</h4>
      </div>
      <div class="max-h-80 overflow-auto">
        {% include 'automate/include/account_trades.html' with broker_type=broker_type id=id only_closed_trades=only_closed_trades thead_class='sticky top-0 bg-background z-10' %}
      </div>
    </section>
  {% endif %}

  {# ===== CHART INITIALIZATION SCRIPTS ===== #}
  <script type="text/javascript">
  (function() {
    const cid = '{{ cid }}';
    const chartId = '{{ id }}-{{ cid }}';
    
    // Win Rate Donut Chart
    const winRateCtx = document.getElementById('winRateDonut-{{ cid }}');
    if (winRateCtx) {
      new Chart(winRateCtx, {
        type: 'doughnut',
        data: {
          labels: ['Wins', 'Losses'],
          datasets: [{
            data: [{{ overview_data.winning_trades|default:0 }}, {{ overview_data.losing_trades|default:0 }}],
            backgroundColor: [
              getCssVariableColor('--color-profit'),
              getCssVariableColor('--color-loss')
            ],
            borderWidth: 0,
            cutout: '75%'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: getCssVariableColor('--color-background'),
              titleColor: getCssVariableColor('--color-title'),
              bodyColor: getCssVariableColor('--color-text'),
              padding: 10,
              cornerRadius: 8
            }
          }
        }
      });
    }
    
    // Buy/Sell Pie Chart
    const buySellCtx = document.getElementById('buySellPie-{{ cid }}');
    if (buySellCtx) {
      new Chart(buySellCtx, {
        type: 'pie',
        data: {
          labels: ['Buy', 'Sell'],
          datasets: [{
            data: [{{ overview_data.buy_trades|default:0 }}, {{ overview_data.sell_trades|default:0 }}],
            backgroundColor: [
              getCssVariableColor('--color-primary'),
              'rgba(128, 128, 128, 0.5)'
            ],
            borderWidth: 0
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              backgroundColor: getCssVariableColor('--color-background'),
              titleColor: getCssVariableColor('--color-title'),
              bodyColor: getCssVariableColor('--color-text'),
              padding: 10,
              cornerRadius: 8
            }
          }
        }
      });
    }
    
    // Currency tabs for main chart
    const tabsContainer = document.getElementById('currency-tabs-{{ cid }}');
    const tabs = tabsContainer ? tabsContainer.querySelectorAll('.currency-tab-{{ cid }}') : [];
    
    function switchTab(btn, chartData) {
      const currency = btn.dataset.currency;
      
      tabs.forEach(t => {
        t.classList.remove('bg-primary', 'text-white');
        t.classList.add('bg-text/10', 'text-text/60');
      });
      btn.classList.remove('bg-text/10', 'text-text/60');
      btn.classList.add('bg-primary', 'text-white');
      
      document.querySelectorAll('.chart-stats-{{ cid }}').forEach(el => el.classList.add('hidden'));
      const statsEl = document.getElementById('chart-stats-' + currency + '-{{ cid }}');
      if (statsEl) statsEl.classList.remove('hidden');
      
      if (typeof loadAccountProfitCharts === 'function') {
        loadAccountProfitCharts('perfChart2-' + chartId, chartData);
      }
    }
    
    tabs.forEach(btn => {
      btn.addEventListener('click', function(e) {
        e.preventDefault();
        try {
          const chartData = JSON.parse(this.dataset.chartData);
          switchTab(this, chartData);
        } catch(err) {
          console.error('Failed to parse chart data:', err);
        }
      });
    });
    
    setTimeout(() => {
      if (tabs.length > 0) tabs[0].click();
    }, 100);
  })();
  </script>
{% endif %}
