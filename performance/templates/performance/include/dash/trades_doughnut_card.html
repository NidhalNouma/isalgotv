{% load custom_tags %}
{% load custom_filters %}

{% with breakeven=value|subtract:win|subtract:loss win_pct=win|divide:value|multiply:100 loss_pct=loss|divide:value|multiply:100 %}
  {% with be_pct=breakeven|divide:value|multiply:100 %}
    <div class=" rounded-xl {{ class }}">
      <div class="flex items-center justify-between mb-4">
        <h4 class="text-sm font-semibold text-title/80 flex items-center gap-2">
          {% if dot_color %}
            <span class="w-3 h-3 rounded-full {{ dot_color }}"></span>
          {% endif %}
          {{ title }}
        </h4>
      </div>

      <div class="flex flex-col sm:flex-row items-center gap-4">
        {# Doughnut Chart #}
        <div class="relative w-28 h-28 sm:w-32 sm:h-32 flex-shrink-0">
          <svg class="w-full h-full" viewBox="0 0 36 36" style="transform: scaleX(-1) rotate(-90deg); transform-origin: 50% 50%;">
            {# Background circle #}
            {% if value == 0 %}
              <circle cx="18" cy="18" r="14" fill="none" stroke="currentColor" stroke-width="3" class="text-text/10" />
            {% elif value > 0 %}
              {# Loss segment (red) #}
              {% if loss_pct > 0 %}
                <defs>
                  <radialGradient id="lossGradient" cx="18" cy="18" r="15" gradientUnits="userSpaceOnUse">
                    <!-- transparent at the inner edge of the stroke, full color at the outer edge -->
                    <stop offset="86.6667%" stop-color="hsl(var(--color-loss))" stop-opacity="0" />
                    <stop offset="100%" stop-color="hsl(var(--color-loss))" stop-opacity="1" />
                  </radialGradient>
                </defs>
                <circle cx="18" cy="18" r="14" fill="none" stroke="url(#lossGradient)" stroke-width="4" stroke-dasharray="{{ loss_pct|multiply:0.88 }} 88" stroke-dashoffset="-{{ win_pct|multiply:0.88 }}" class="text-loss" />
              {% endif %}
              {# Win segment (green) #}

              <defs>
                <radialGradient id="profitGradient" cx="18" cy="18" r="15" gradientUnits="userSpaceOnUse">
                  <!-- transparent at the inner edge of the stroke, full color at the outer edge -->
                  <stop offset="86.6667%" stop-color="hsl(var(--color-profit))" stop-opacity="0" />
                  <stop offset="100%" stop-color="hsl(var(--color-profit))" stop-opacity="1" />
                </radialGradient>
              </defs>
              <circle cx="18" cy="18" r="14" fill="none" stroke="url(#profitGradient)" stroke-width="4" stroke-dasharray="{{ win_pct|multiply:0.88 }} 88" stroke-dashoffset="0" class="text-profit" />

              {# Breakeven segment (gray) #}
              {% if be_pct > 0 %}
                {% with win_loss_pct=win_pct|add:loss_pct %}
                  <defs>
                    <radialGradient id="beGradient" cx="18" cy="18" r="15" gradientUnits="userSpaceOnUse">
                      <!-- transparent at the inner edge of the stroke, full color at the outer edge -->
                      <stop offset="86.6667%" stop-color="hsl(var(--color-text))" stop-opacity="0" />
                      <stop offset="100%" stop-color="hsl(var(--color-text))" stop-opacity="1" />
                    </radialGradient>
                  </defs>
                  <circle cx="18" cy="18" r="14" fill="none" stroke="url(#beGradient)" stroke-width="4" stroke-dasharray="{{ be_pct|multiply:0.88 }} 88" stroke-dashoffset="-{{ win_loss_pct|multiply:0.88 }}" class="text-text/40" />
                {% endwith %}
              {% endif %}
            {% endif %}
          </svg>

          {# Center text - Total trades #}
          <div class="absolute inset-0 flex flex-col items-center justify-center">
            <span class="text-xl sm:text-2xl font-bold text-title">{{ value|default:'0'|abbrev }}</span>
            <span class="text-[10px] sm:text-xs text-text/60">trades</span>
          </div>
        </div>

        {# Legend #}
        <div class="flex flex-col gap-3 sm:gap-2 flex-wrap justify-center">
          <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-profit"></span>
            <span class="text-xs text-text/70">Win</span>
            <span class="text-xs font-semibold text-profit">{{ win|default:'0' }}</span>
            <span class="text-[10px] text-profit/90">({{ win_rate|default:'0'|floatformat:1 }}%)</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-loss"></span>
            <span class="text-xs text-text/70">Loss</span>
            <span class="text-xs font-semibold text-loss">{{ loss|default:'0' }}</span>
            <span class="text-[10px] text-loss/90">({{ loss_pct|default:'0'|floatformat:1 }}%)</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="w-3 h-3 rounded-full bg-text/50"></span>
            <span class="text-xs text-text/70">BE</span>
            <span class="text-xs font-semibold text-text/60">{{ breakeven|default:'0' }}</span>
            <span class="text-[10px] text-text/50">({{ be_pct|default:'0'|floatformat:1 }}%)</span>
          </div>
        </div>
      </div>
    </div>
  {% endwith %}
{% endwith %}
