{% load custom_filters %}
<div
  id="edit-{{account.id}}-{{account.broker_type}}-modal"
  data-modal-target="edit-{{account.id}}-{{account.broker_type}}-modal"
  data-modal-backdrop="static"
  tabindex="-1"
  aria-hidden="true"
  class="fixed top-0 left-0 right-0 z-50 hidden p-4 overflow-x-hidden overflow-y-auto md:inset-0 h-[calc(100%-1rem)] max-h-full"
>
  <div
    class="relative w-full max-w-xl max-h-full overflow-y-scroll no-scrollbar  bg-background rounded-lg shadow flex flex-col"
  >
    <!-- Modal header -->
    <div
      class="flex items-center justify-between p-4 sticky top-0 bg-gradient-to-b via-75% from-background via-background z-50 rounded-t-lg"
    >
      <h3 class="text-xl font-semibold text-title flex items-center capitalize space-x-3">
        <span id="add-{{account.id}}_{{account.broker_type}}-form-btn" class="pointer-events-none" onclick="swapDivBtn('edit-{{account.id}}_{{account.broker_type}}-sub', 'add-{{account.id}}_{{account.broker_type}}-form')">Edit Account</span>
        {% if account.subscription_id != 'free_access' %}
          <span class="">|</span>
          <form 
            hx-post="{% url 'get_account_subscription_data' account.broker_type account.id account.subscription_id %}" 
            hx-target="#edit-{{account.id}}_{{account.broker_type}}-sub"
            hx-wait="swap"
          >
            {% csrf_token %}
            <button type="submit" id="edit-{{account.id}}_{{account.broker_type}}-sub-btn" class="text-title/80 cursor-pointer hover:text-title/60 transition-all" onclick="swapDivBtn('add-{{account.id}}_{{account.broker_type}}-form', 'edit-{{account.id}}_{{account.broker_type}}-sub')">Subscription</button>
          </form>
        {% endif %}
      </h3>
      <button
        type="button"
        class="text-title/60 bg-transparent hover:text-title rounded-lg text-sm p-1.5 ml-auto inline-flex items-center"
        data-modal-hide="edit-{{account.id}}-{{account.broker_type}}-modal"
        onclick="hideModel('edit-{{account.id}}-{{account.broker_type}}-modal');"
      >
        <svg
          class="w-5 h-5"
          fill="currentColor"
          viewBox="0 0 20 20"
          xmlns="http://www.w3.org/2000/svg"
        >
          <path
            fill-rule="evenodd"
            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
            clip-rule="evenodd"
          ></path>
        </svg>
      </button>
    </div>
    <section id="edit-{{account.id}}_{{account.broker_type}}-sub" class="hidden relative p-6 pt-2 w-full max-w-md mx-auto flex-col gap-y-4">
      {% include "include/edit_broker_membership.html" with id=account.id broker_type=account.broker_type %}
    </section>
    <form
      class="relative p-6 pt-2 w-full max-w-md mx-auto flex flex-col gap-y-4"
      id="add-{{account.id}}_{{account.broker_type}}-form"
      hx-post="{% url 'edit_crypto_broker_account' account.broker_type account.id %}"
      hx-target="#at-accounts"
      hx-wait="swap"
    >
      <div class="w-full">
        <label
          for="{{account.id}}_{{account.broker_type}}_name"
          class="input-label"
          >Name</label
        >
        <input
          type="text"
          id="{{account.id}}_{{account.broker_type}}_name"
          name="{{account.id}}_{{account.broker_type}}_name"
          class="input-text w-full"
          placeholder="Give your account a name"
          value="{{account.name}}"
        />
      </div>
      <div class="w-full">
        <label for="{{account.id}}_{{account.broker_type}}_apiKey" class="input-label">
          {% if account.broker_type == "hyperliquid" %}
            Wallet Address
          {% else %}
            API key
          {% endif %}
        </label>
        <input
          type="text"
          id="{{account.id}}_{{account.broker_type}}_apiKey"
          name="{{account.id}}_{{account.broker_type}}_apiKey"
          class="input-text w-full"
          placeholder="{% if account.broker_type == 'hyperliquid' %}Your wallet address{% else %}Your API key{% endif %}"
          value="{{account.apiKey}}"
        />
      </div>
      <div class="w-full">
        <label
          for="{{account.id}}_{{account.broker_type}}_secretKey"
          class="input-label"
          >Secret key</label
        >
        <input
          type="password"
          id="{{account.id}}_{{account.broker_type}}_secretKey"
          name="{{account.id}}_{{account.broker_type}}_secretKey"
          class="input-text w-full"
          placeholder="Your API secret key"
          value="{{account.secretKey}}"
        />
      </div>
      {% if account.broker_type == "bitget" or account.broker_type == 'kucoin' or account.broker_type == 'okx' or account.broker_type == 'apex' %}
      <div class="w-full">
        <label for="{{broker_type}}_passphrase" class="input-label"
          >Passphrase</label
        >
        <input
          type="text"
          id="{{account.id}}_{{account.broker_type}}_passphrase"
          name="{{account.id}}_{{account.broker_type}}_pass_phrase"
          class="input-text w-full"
          placeholder="Your passphrase"
          {% if account.broker_type == "apex" %}
          value="{{account.pass_phrase|str_split:'||'|index:0}}"
          {% else %}
          value="{{account.pass_phrase}}"
          {% endif %}
        />
      </div>
      {% endif %}
      {% if account.broker_type == "bitmart" %}
      <div class="w-full">
        <label for="{{broker_type}}_passphrase" class="input-label"
          >Memo</label
        >
        <input
          type="text"
          id="{{account.id}}_{{account.broker_type}}_passphrase"
          name="{{account.id}}_{{account.broker_type}}_pass_phrase"
          class="input-text w-full"
          placeholder="Your memo"
          value="{{account.pass_phrase}}"
        />
      </div>
      {% endif %}
      {% if account.broker_type == "apex" %}
        <div class="w-full">
          <label for="{{account.id}}_{{account.broker_type}}_omni_key" class="input-label">Omni Key</label>
          <input type="password" id="{{account.id}}_{{account.broker_type}}_omni_key" name="{{account.id}}_{{account.broker_type}}_omni_key" class="input-text w-full" placeholder="Your omni key" value="{{account.pass_phrase|str_split:'||'|index:1}}" />
        </div>
      {% endif %}
      <div class="w-full">
        <label for="type" class="input-label">Type</label>

        <ul
          class="items-center w-full text-sm font-medium text-text/80 bg-text/10 rounded-md"
        >
        {% if account.broker_type != 'apex' and account.broker_type != 'hyperliquid' %}
          <li class="w-full">
            <div class="flex items-center ps-3">
              <input
                id="{{account.id}}_{{account.broker_type}}-type-S"
                type="radio"
                value="S"
                name="{{account.id}}_{{account.broker_type}}_type"
                class="w-4 h-4 text-title bg-background border-text border checked:!border checked:!border-text dark:checked:!bg-transparent focus:ring-0"
                {% if account.type == "S" %}checked{% endif %}
              />
              <label
                for="{{account.id}}_{{account.broker_type}}-type-S"
                class="w-full py-3 ms-2 input-label mb-0 cursor-pointer"
                >Spot
              </label>
            </div>
          </li>
          {% endif %}
          {% if account.broker_type == "binance" or account.broker_type == 'bingx' %}
          <li class="w-full">
            <div class="flex items-center ps-3">
              <input
                id="{{account.id}}_{{account.broker_type}}-type-M"
                type="radio"
                value="U"
                name="{{account.id}}_{{account.broker_type}}_type"
                class="w-4 h-4 text-title bg-background border-text border checked:!border checked:!border-text dark:checked:!bg-transparent focus:ring-0"
                {% if account.type == "U" %}checked{% endif %}
              />
              <label
                for="{{account.id}}_{{account.broker_type}}-type-M"
                class="w-full py-3 ms-2 input-label mb-0 cursor-pointer"
                >USDâ“¢@M</label
              >
            </div>
          </li>
          {% endif %} 
          {% if account.broker_type == "binance" or account.broker_type == 'bingx' %}
          <li class="w-full">
            <div class="flex items-center ps-3">
              <input
                id="{{account.id}}_{{account.broker_type}}-type-C"
                type="radio"
                value="C"
                name="{{account.id}}_{{account.broker_type}}_type"
                class="w-4 h-4 text-title bg-background border-text border checked:!border checked:!border-text dark:checked:!bg-transparent focus:ring-0"
                {% if account.type == "C" %}checked{% endif %}
              />
              <label
                for="{{account.id}}_{{account.broker_type}}-type-C"
                class="w-full py-3 ms-2 input-label mb-0 cursor-pointer"
                >COIN@M</label
              >
            </div>
          </li>
          {% endif %} 
          {% if account.broker_type == "bitget" %}
          <li class="w-full">
            <div class="flex items-center ps-3">
              <input
                id="{{account.id}}_{{account.broker_type}}-type-F"
                type="radio"
                value="U"
                name="{{account.id}}_{{account.broker_type}}_type"
                {% if account.type == "U" %}checked{% endif %}
                class="w-4 h-4 text-title bg-background border-text border checked:!border checked:!border-text dark:checked:!bg-transparent focus:ring-0"
              />
              <label
                for="{{account.id}}_{{account.broker_type}}-type-F"
                class="w-full py-3 ms-2 input-label mb-0 cursor-pointer"
                >USDT-M</label
              >
            </div>
          </li>
          <li class="w-full">
            <div class="flex items-center ps-3">
              <input
                id="{{account.id}}_{{account.broker_type}}-type-C"
                type="radio"
                value="C"
                name="{{account.id}}_{{account.broker_type}}_type"
                {% if account.type == "C" %}checked{% endif %}
                class="w-4 h-4 text-title bg-background border-text border checked:!border checked:!border-text dark:checked:!bg-transparent focus:ring-0"
              />
              <label
                for="{{account.id}}_{{account.broker_type}}-type-C"
                class="w-full py-3 ms-2 input-label mb-0 cursor-pointer"
                >COIN-M</label
              >
            </div>
          </li>
          <li class="w-full">
            <div class="flex items-center ps-3">
              <input
                id="{{account.id}}_{{account.broker_type}}-type-Uc"
                type="radio"
                value="UC"
                name="{{account.id}}_{{account.broker_type}}_type"
                {% if account.type == "UC" %}checked{% endif %}
                class="w-4 h-4 text-title bg-background border-text border checked:!border checked:!border-text dark:checked:!bg-transparent focus:ring-0"
              />
              <label
                for="{{account.id}}_{{account.broker_type}}-type-Uc"
                class="w-full py-3 ms-2 input-label mb-0 cursor-pointer"
                >USDC-M</label
              >
            </div>
          </li>
          {% endif %} 

          {% if account.broker_type == 'coinbase' or account.broker_type == "okx" or account.broker_type == "crypto" or account.broker_type == "apex" or account.broker_type == "hyperliquid" %}
            <li class="w-full">
              <div class="flex items-center ps-3">
                <input {% if account.type == "P" %}checked{% endif %} id="{{account.id}}_{{account.broker_type}}-type-P" type="radio" value="P" name="{{account.id}}_{{account.broker_type}}_type" class="w-4 h-4 text-title bg-background border-text border checked:!border checked:!border-text dark:checked:!bg-transparent focus:ring-0" />
                <label for="{{account.id}}_{{account.broker_type}}-type-P" class="w-full py-3 ms-2 input-label mb-0 cursor-pointer">{% if account.broker_type == "okx" %}Futures{% else %}Perps{% endif %}</label>
              </div>
            </li>
          {% endif %}

          {% if account.broker_type == 'mexc' or account.broker_type == 'bitmart' or account.broker_type == 'bybit' or account.broker_type == 'kucoin' or account.broker_type == 'coinbase' or account.broker_type == "okx" or account.broker_type == "kraken" %}
            <li class="w-full">
              <div class="flex items-center ps-3">
                <input {% if account.type == "F" %}checked{% endif %} id="{{account.id}}_{{account.broker_type}}-type-F" type="radio" value="F" name="{{account.id}}_{{account.broker_type}}_type" class="w-4 h-4 text-title bg-background border-text border checked:!border checked:!border-text dark:checked:!bg-transparent focus:ring-0" />
                <label for="{{account.id}}_{{account.broker_type}}-type-F" class="w-full py-3 ms-2 input-label mb-0 cursor-pointer">{% if account.broker_type == "okx" %}Expiry{% endif %} Futures</label>
              </div>
            </li>
          {% endif %}
        </ul>
      </div>

      {% csrf_token %}

      <div
        id="edit-{{account.id}}_{{account.broker_type}}-form-errors"
        class="my-2"
      ></div>

      <div class="w-full">
        <button
          id="btn-edit-{{account.id}}_{{account.broker_type}}"
          type="submit"
          class="btn-accent mb-2 w-full mx-auto"
          onclick="document.getElementById('edit-{{account.id}}_{{account.broker_type}}-form-errors').innerHTML = '';  openLoader('', '-edit-{{account.id}}_{{account.broker_type}}', 'flex');"
        >
          Save
          <svg
            class="h-4 aspect-square ml-1"
            xmlns="http://www.w3.org/2000/svg"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2"
            stroke-linecap="round"
            stroke-linejoin="round"
            class="lucide lucide-download"
          >
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
            <polyline points="7 10 12 15 17 10" />
            <line x1="12" x2="12" y1="15" y2="3" />
          </svg>
        </button>
        <button
          id="spinner-edit-{{account.id}}_{{account.broker_type}}"
          disabled
          type="button"
          class="btn-accent mb-2 w-full mx-auto hidden"
        >
          Saving {% include 'svg/spinner.html' with class='ml-1.5 h-4' %}
        </button>
      </div>
    </form>
  </div>
</div>
