{% extends 'unfold/layouts/base.html' %}

{% load admin_urls i18n unfold %}

{% block breadcrumbs %}
  {% if not is_popup %}
    <div class="px-4 lg:px-8">
      <div class="container mb-6 mx-auto -my-3 lg:mb-12">
        <ul class="flex flex-wrap">
          {% url 'admin:index' as link %}
          {% trans 'Home' as name %}
          {% include 'unfold/helpers/breadcrumb_item.html' with link=link name=name %}
          {% trans 'Marketing Email' as name %}
          {% include 'unfold/helpers/breadcrumb_item.html' with name=name %}
        </ul>
      </div>
    </div>
  {% endif %}
{% endblock %}

{% block content %}
  <div class="px-4 lg:px-8">
    <div class="container mb-6 mx-auto -my-3 lg:mb-12">
      <form method="post" id="marketing_email_form" novalidate>
        {% if messages %}
          <div class="mb-4 px-3">
            {% for message in messages %}
              {% if 'error' in message.tags %}
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-2" role="alert">{{ message }}</div>
              {% elif 'success' in message.tags %}
                <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-2" role="status">{{ message }}</div>
              {% else %}
                <div class="bg-gray-100 border border-gray-300 text-gray-700 px-4 py-3 rounded mb-2" role="alert">{{ message }}</div>
              {% endif %}
            {% endfor %}
          </div>
        {% endif %}

        {% csrf_token %}

        {# ── Recipients ── #}
        <div class="group/row field-row form-row">
          <div class="field-recipient_type field-line flex-col group/line py-2.5 flex-grow flex px-3">
            <label class="block font-semibold mb-2 text-font-important-light text-sm dark:text-font-important-dark required" for="recipient_type">Send to:</label>
            <select name="recipient_type" id="recipient_type" class="border border-base-200 bg-white font-medium placeholder-base-400 rounded shadow-sm text-font-default-light text-sm focus:ring focus:ring-primary-300 focus:border-primary-600 focus:outline-none dark:bg-base-900 dark:border-base-700 dark:text-font-default-dark dark:focus:ring-primary-700 dark:focus:border-primary-600 px-3 py-2 w-full max-w-2xl">
              <option value="all">All users</option>
              <option value="lifetime">Lifetime users</option>
              <option value="non_lifetime">Non-lifetime users</option>
              <option value="subscribers">Subscriber users</option>
              <option value="non_subscribers">Non-subscriber users</option>
            </select>
          </div>
        </div>

        {# ── Subject ── #}
        <div class="group/row field-row form-row">
          <div class="field-subject field-line flex-col group/line py-2.5 flex-grow flex px-3">
            <label class="block font-semibold mb-2 text-font-important-light text-sm dark:text-font-important-dark required" for="subject">Subject:</label>
            <input required type="text" name="subject" id="subject" placeholder="e.g. New Strategy Available" class="border border-base-200 bg-white font-medium placeholder-base-400 rounded shadow-sm text-font-default-light text-sm focus:ring focus:ring-primary-300 focus:border-primary-600 focus:outline-none dark:bg-base-900 dark:border-base-700 dark:text-font-default-dark dark:focus:ring-primary-700 dark:focus:border-primary-600 px-3 py-2 w-full max-w-2xl" />
          </div>
        </div>

        {# ── Preheader ── #}
        <div class="group/row field-row form-row">
          <div class="field-preheader field-line flex-col group/line py-2.5 flex-grow flex px-3">
            <label class="block font-semibold mb-2 text-font-important-light text-sm dark:text-font-important-dark" for="preheader">Preheader <span class="font-normal text-base-400">(inbox preview text, optional)</span>:</label>
            <input type="text" name="preheader" id="preheader" placeholder="Short preview shown in the inbox" class="border border-base-200 bg-white font-medium placeholder-base-400 rounded shadow-sm text-font-default-light text-sm focus:ring focus:ring-primary-300 focus:border-primary-600 focus:outline-none dark:bg-base-900 dark:border-base-700 dark:text-font-default-dark dark:focus:ring-primary-700 dark:focus:border-primary-600 px-3 py-2 w-full max-w-2xl" />
          </div>
        </div>

        {# ── Sections ── #}
        <div id="sections-container" class="mt-4">
          <div class="flex items-center justify-between px-3 mb-2">
            <h3 class="font-semibold text-font-important-light text-sm dark:text-font-important-dark">Sections</h3>
            <button type="button" id="add-section-btn" class="flex items-center gap-1 border border-base-200 font-medium px-3 py-1.5 rounded text-sm text-font-default-light bg-white hover:bg-base-50 dark:border-base-700 dark:bg-base-900 dark:text-font-default-dark dark:hover:bg-base-800">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                <path d="M12 5v14M5 12h14" />
              </svg>Add Section
            </button>
          </div>

          {# First section always present #}
          <div class="section-block bg-base-50 dark:bg-base-800 rounded-lg p-4 mx-3 mb-4 border border-base-200 dark:border-base-700 relative" data-index="0">
            <div class="flex items-center justify-between mb-3">
              <span class="section-label font-semibold text-sm text-font-important-light dark:text-font-important-dark">Section 1</span>
              <button type="button" class="remove-section-btn text-red-500 hover:text-red-700 text-xs font-medium hidden">Remove</button>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
              <div>
                <label class="block text-xs font-medium mb-1 text-font-default-light dark:text-font-default-dark">Title</label>
                <input type="text" name="sections[0][title]" placeholder="Section heading" class="border border-base-200 bg-white font-medium placeholder-base-400 rounded shadow-sm text-sm focus:ring focus:ring-primary-300 focus:border-primary-600 focus:outline-none dark:bg-base-900 dark:border-base-700 dark:text-font-default-dark px-3 py-2 w-full" />
              </div>
              <div>
                <label class="block text-xs font-medium mb-1 text-font-default-light dark:text-font-default-dark">Alignment</label>
                <select name="sections[0][align]" class="border border-base-200 bg-white font-medium rounded shadow-sm text-sm focus:ring focus:ring-primary-300 focus:border-primary-600 focus:outline-none dark:bg-base-900 dark:border-base-700 dark:text-font-default-dark px-3 py-2 w-full">
                  <option value="left">Left</option>
                  <option value="center">Center</option>
                </select>
              </div>
            </div>

            <div class="mb-3">
              <label class="block text-xs font-medium mb-1 text-font-default-light dark:text-font-default-dark">Description <span class="font-normal text-base-400">(HTML allowed)</span></label>
              <textarea name="sections[0][description]" rows="3" placeholder="Section body text..." class="border border-base-200 bg-white font-medium placeholder-base-400 rounded shadow-sm text-sm focus:ring focus:ring-primary-300 focus:border-primary-600 focus:outline-none dark:bg-base-900 dark:border-base-700 dark:text-font-default-dark px-3 py-2 w-full"></textarea>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
              <div>
                <label class="block text-xs font-medium mb-1 text-font-default-light dark:text-font-default-dark">Image Position</label>
                <select name="sections[0][image_position]" class="border border-base-200 bg-white font-medium rounded shadow-sm text-sm focus:ring focus:ring-primary-300 focus:border-primary-600 focus:outline-none dark:bg-base-900 dark:border-base-700 dark:text-font-default-dark px-3 py-2 w-full">
                  <option value="after">After description</option>
                  <option value="before">Before description</option>
                </select>
              </div>
              <div>
                <label class="block text-xs font-medium mb-1 text-font-default-light dark:text-font-default-dark">Images per Row</label>
                <select name="sections[0][images_per_row]" class="border border-base-200 bg-white font-medium rounded shadow-sm text-sm focus:ring focus:ring-primary-300 focus:border-primary-600 focus:outline-none dark:bg-base-900 dark:border-base-700 dark:text-font-default-dark px-3 py-2 w-full">
                  <option value="1">1 (full width)</option>
                  <option value="2">2 per row</option>
                  <option value="3">3 per row</option>
                </select>
              </div>
            </div>

            {# ── Images list ── #}
            <div class="images-container mb-3">
              <div class="flex items-center justify-between mb-2">
                <label class="block text-xs font-medium text-font-default-light dark:text-font-default-dark">Images <span class="font-normal text-base-400">(optional)</span></label>
                <button type="button" class="add-image-btn flex items-center gap-1 text-xs font-medium text-primary-600 hover:text-primary-700 dark:text-primary-400">
                  <svg class="w-3 aspect-square" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M12 5v14M5 12h14" />
                  </svg>Add Image
                </button>
              </div>
              <div class="image-block flex items-start gap-2 mb-2" data-img-index="0">
                <div class="flex-1 grid grid-cols-1 md:grid-cols-3 gap-2">
                  <input type="url" name="sections[0][images][0][src]" placeholder="Image URL" class="border border-base-200 bg-white font-medium placeholder-base-400 rounded shadow-sm text-sm focus:ring focus:ring-primary-300 focus:border-primary-600 focus:outline-none dark:bg-base-900 dark:border-base-700 dark:text-font-default-dark px-3 py-1.5 w-full" />
                  <input type="url" name="sections[0][images][0][link]" placeholder="Image link (optional)" class="border border-base-200 bg-white font-medium placeholder-base-400 rounded shadow-sm text-sm focus:ring focus:ring-primary-300 focus:border-primary-600 focus:outline-none dark:bg-base-900 dark:border-base-700 dark:text-font-default-dark px-3 py-1.5 w-full" />
                  <input type="text" name="sections[0][images][0][alt]" placeholder="Alt text (optional)" class="border border-base-200 bg-white font-medium placeholder-base-400 rounded shadow-sm text-sm focus:ring focus:ring-primary-300 focus:border-primary-600 focus:outline-none dark:bg-base-900 dark:border-base-700 dark:text-font-default-dark px-3 py-1.5 w-full" />
                </div>
                <button type="button" class="remove-image-btn text-red-500 hover:text-red-700 mt-1.5 hidden" title="Remove image">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M18 6 6 18M6 6l12 12" />
                  </svg>
                </button>
              </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
              <div>
                <label class="block text-xs font-medium mb-1 text-font-default-light dark:text-font-default-dark">Button Text <span class="font-normal text-base-400">(optional)</span></label>
                <input type="text" name="sections[0][cta_text]" placeholder="e.g. Learn More →" class="border border-base-200 bg-white font-medium placeholder-base-400 rounded shadow-sm text-sm focus:ring focus:ring-primary-300 focus:border-primary-600 focus:outline-none dark:bg-base-900 dark:border-base-700 dark:text-font-default-dark px-3 py-2 w-full" />
              </div>
              <div>
                <label class="block text-xs font-medium mb-1 text-font-default-light dark:text-font-default-dark">Button URL</label>
                <input type="url" name="sections[0][cta_url]" placeholder="https://..." class="border border-base-200 bg-white font-medium placeholder-base-400 rounded shadow-sm text-sm focus:ring focus:ring-primary-300 focus:border-primary-600 focus:outline-none dark:bg-base-900 dark:border-base-700 dark:text-font-default-dark px-3 py-2 w-full" />
              </div>
            </div>
          </div>
        </div>

        {# ── Submit bar ── #}
        <div id="submit-row" class="relative lg:mt-16 z-20">
          <div class="w-full lg:bottom-0 lg:fixed lg:left-0 lg:right-0 xl:left-0">
            <div class="flex flex-col-reverse gap-3 items-center lg:flex-row backdrop-blur-sm bg-white/80 pb-4 dark:bg-base-900/80 lg:border-t lg:border-base-200 lg:py-4 relative lg:scrollable-top lg:px-8 dark:border-base-800">
              <button type="button" id="preview-btn" class="ml-auto border border-base-200 font-medium px-3 py-2 rounded text-font-default-light bg-white hover:bg-base-50 w-full lg:w-auto dark:border-base-700 dark:bg-base-900 dark:text-font-default-dark dark:hover:bg-base-800">Preview</button>
              <button type="submit" class="bg-primary-600 block border border-transparent font-medium px-3 py-2 rounded text-white w-full lg:w-auto">Send Email</button>
            </div>
          </div>
        </div>
      </form>
    </div>
  </div>

  <script>
    ;(function () {
      const container = document.getElementById('sections-container')
      const addBtn = document.getElementById('add-section-btn')
      let sectionCount = 1
    
      // ── Image management ──
      function initImageButtons(sectionBlock) {
        const imgContainer = sectionBlock.querySelector('.images-container')
        const addImgBtn = sectionBlock.querySelector('.add-image-btn')
    
        addImgBtn.addEventListener('click', () => {
          const imgBlocks = imgContainer.querySelectorAll('.image-block')
          const newIdx = imgBlocks.length
          const template = imgBlocks[0].cloneNode(true)
          template.dataset.imgIndex = newIdx
          template.querySelectorAll('input').forEach((el) => {
            el.value = ''
            el.name = el.name.replace(/\[images\]\[\d+\]/, `[images][${newIdx}]`)
          })
          const removeBtn = template.querySelector('.remove-image-btn')
          removeBtn.classList.remove('hidden')
          removeBtn.addEventListener('click', () => {
            template.remove()
            renumberImages(imgContainer, sectionBlock.dataset.index)
          })
          imgContainer.appendChild(template)
          renumberImages(imgContainer, sectionBlock.dataset.index)
        })
    
        // Wire up existing remove buttons
        imgContainer.querySelectorAll('.remove-image-btn').forEach((btn) => {
          btn.addEventListener('click', () => {
            btn.closest('.image-block').remove()
            renumberImages(imgContainer, sectionBlock.dataset.index)
          })
        })
      }
    
      function renumberImages(imgContainer, sectionIdx) {
        const imgBlocks = imgContainer.querySelectorAll('.image-block')
        imgBlocks.forEach((block, j) => {
          block.dataset.imgIndex = j
          block.querySelectorAll('input').forEach((el) => {
            el.name = el.name.replace(/sections\[\d+\]\[images\]\[\d+\]/, `sections[${sectionIdx}][images][${j}]`)
          })
          const removeBtn = block.querySelector('.remove-image-btn')
          if (imgBlocks.length <= 1) {
            removeBtn.classList.add('hidden')
          } else {
            removeBtn.classList.remove('hidden')
          }
        })
      }
    
      // Init first section's image buttons
      initImageButtons(container.querySelector('.section-block'))
    
      function createSection(index) {
        const block = container.querySelector('.section-block').cloneNode(true)
        block.dataset.index = index
        block.querySelector('.section-label').textContent = `Section ${index + 1}`
        // Clear all input values
        block.querySelectorAll('input, textarea').forEach((el) => {
          el.value = ''
          el.name = el.name.replace(/\[\d+\]/, `[${index}]`)
        })
        block.querySelectorAll('select').forEach((el) => {
          el.selectedIndex = 0
          el.name = el.name.replace(/\[\d+\]/, `[${index}]`)
        })
    
        // Reset images to just one empty block
        const imgContainer = block.querySelector('.images-container')
        const imgBlocks = imgContainer.querySelectorAll('.image-block')
        // Keep only the first, remove the rest
        for (let i = imgBlocks.length - 1; i > 0; i--) {
          imgBlocks[i].remove()
        }
        const firstImg = imgContainer.querySelector('.image-block')
        firstImg.dataset.imgIndex = 0
        firstImg.querySelectorAll('input').forEach((el) => {
          el.value = ''
          el.name = el.name.replace(/sections\[\d+\]\[images\]\[\d+\]/, `sections[${index}][images][0]`)
        })
        firstImg.querySelector('.remove-image-btn').classList.add('hidden')
    
        // Show remove button
        const removeBtn = block.querySelector('.remove-section-btn')
        removeBtn.classList.remove('hidden')
        removeBtn.addEventListener('click', () => {
          block.remove()
          renumberSections()
        })
    
        // Init image buttons for this new section
        initImageButtons(block)
    
        return block
      }
    
      function renumberSections() {
        container.querySelectorAll('.section-block').forEach((block, i) => {
          block.dataset.index = i
          block.querySelector('.section-label').textContent = `Section ${i + 1}`
          // Renumber non-image inputs
          block.querySelectorAll('input:not([name*="[images]"]), textarea, select').forEach((el) => {
            el.name = el.name.replace(/sections\[\d+\]/, `sections[${i}]`)
          })
          // Renumber image inputs
          const imgContainer = block.querySelector('.images-container')
          renumberImages(imgContainer, i)
    
          const removeBtn = block.querySelector('.remove-section-btn')
          if (i === 0 && container.querySelectorAll('.section-block').length === 1) {
            removeBtn.classList.add('hidden')
          } else {
            removeBtn.classList.remove('hidden')
          }
        })
        sectionCount = container.querySelectorAll('.section-block').length
      }
    
      addBtn.addEventListener('click', () => {
        const section = createSection(sectionCount)
        container.appendChild(section)
        sectionCount++
        renumberSections()
        section.scrollIntoView({ behavior: 'smooth', block: 'center' })
      })
    
      // Preview
      document.getElementById('preview-btn').addEventListener('click', () => {
        const form = document.getElementById('marketing_email_form')
        const formData = new FormData(form)
        formData.append('preview', '1')
    
        fetch(window.location.href, {
          method: 'POST',
          body: formData
        })
          .then((r) => r.text())
          .then((html) => {
            const win = window.open('', '_blank')
            win.document.write(html)
            win.document.close()
          })
          .catch((err) => console.error('Preview error:', err))
      })
    })()
  </script>
{% endblock %}
