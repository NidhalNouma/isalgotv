{% if account_subscription %}
  <p class="input-label text-sm">
    Subscription{% if subscription_paused %}
      <span class="bg-text/10 text-text rounded-full ml-0.5 px-1 py-0 font-semibold">paused</span>
    {% elif subscription_status == 'active' %}
      <span class="bg-success/10 text-success rounded-full ml-0.5 px-1 py-0 font-semibold">{{ subscription_status }}</span>
    {% elif subscription_status == 'canceled' %}
      <span class="bg-error/10 text-error rounded-full ml-0.5 px-1 py-0 font-semibold">{{ subscription_status }}</span>
    {% else %}
      <span class="bg-text/10 text-text rounded-full ml-0.5 px-1 py-0 font-semibold">{{ subscription_status }}</span>
    {% endif %}
  </p>

  {% if not subscription_paused and subscription_status != 'canceled' and subscription_status != 'past_due' %}
    <div class="bg-text/5 backdrop-blur-3xl rounded-md p-4 my-3 text-text">
      <div class="flex justify-between items-center mb-2">
        <span class="text-text">Next Payment</span>
      </div>

      <div class="flex justify-between items-center mb-2">
        <span class="text-text/60">Subtotal</span>
        <span>${{ subscription_next_payment_amount }}</span>
      </div>

      <div class="flex justify-between items-center pt-2 border-t border-title/20 mt-2">
        <span class="font-medium text-text/60">Total</span>
        <span class="font-medium text-lg">${{ subscription_next_payment_amount }}</span>
      </div>

      <p class="mt-2.5 text-xs text-text/80">&#9737; Scheduled for {{ next_payment_date|date:'M d Y' }}</p>
    </div>
  {% endif %}

  {% if subscription.status == 'past_due' %}
    <div class="bg-error/5 backdrop-blur-3xl rounded-md p-4 my-3 text-error">
      <div class="flex justify-between items-center mb-2">
        <span class="text-error">Payment Issue</span>
      </div>

      <p class="text-sm text-error/80">There was an issue with your last payment. Please update your payment method to reactivate your subscription.</p>
    </div>
  {% endif %}

  <div class="rounded-md p-1 my-3 text-text">
    {% with title=broker_type|add:'-account_subscription_pm'|add:id %}
      <div id="change-pm-{{ title }}-container" class="">
        {% if pm and subscription_status != 'canceled' and subscription_status != 'past_due' %}
          <div class="flex justify-between items-center mb-2 mt-2">
            <h2 class="font-semibold text-text">Payment Method</h2>
          </div>
          {% include 'include/payment_methods.html' with payment_methods=pm hide_default=True %}
        {% endif %}

        <button id="change-pm-{{ title }}-btn" class="mt-3 btn-text" onclick="mountStripeElement('{{ title }}'); changeHidden('add-{{ title }}-form', 'change-pm-{{ title }}-btn');">
          {% if subscription_status == 'canceled' or subscription_status == 'past_due' %}
            Reactivate the subscription
          {% elif pm %}
            Change Payment Method
          {% else %}
            Select Payment Method
          {% endif %}
        </button>
      </div>

      <form id="add-{{ title }}-form" class="hidden" hx-post="{% url 'change_account_subscription_payment' broker_type id subscription_id %}" hx-target="#edit-{{ id }}_{{ broker_type }}-sub" hx-wait="swap">
        {% include 'include/broker_payment.html' with title=title hide_header=True subtitle='Select a payment method' default_pm_id=default_pm_id %}

        <div id="add-{{ title }}-form-errors" class="my-2"></div>
        {% csrf_token %}
        <div class="flex items-center justify-between gap-2 mt-2">
          <button type="button" class="btn-icon w-full justify-center border border-text/20 py-1.5" onclick="unmountStripeElement('{{ title }}'); changeHidden('change-pm-{{ title }}-btn', 'add-{{ title }}-form');">Cancel</button>
          <button id="spinner-add-{{ title }}" disabled type="button" class="btn-text w-full hidden">Saving{% include 'svg/spinner.html' with class='ml-1.5 h-4' %}</button>
          <button id="btn-add-{{ title }}" onclick="submitStripeElementForm('{{ title }}', 'add-{{ title }}-form-errors', event)" type="submit" class="btn-text w-full">Save</button>
        </div>
      </form>
    {% endwith %}
  </div>
{% else %}
  <!-- Case where 'logs' is None or not passed in the context -->
  <p class="text-text/80 text-sm mb-6 flex items-center text-center">
    Loading{% include 'svg/spinner.html' with class='ml-1.5 h-4' %}
  </p>
{% endif %}

<div id="edit-{{ id }}_{{ broker_type }}-sub-errors" class="my-2"></div>
