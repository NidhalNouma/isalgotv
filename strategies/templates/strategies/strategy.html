{% extends 'page.html' %} {% load static %}
{% load custom_tags %}

{% block head_title %}
  <title>{{ strategy.name }} | Backtestable TradingView Strategy | IsAlgo</title>
{% endblock %}

{% block head_description %}
  <meta name="description" content="{{ strategy.description }}" />
{% endblock %}

{% block head %}
  <script src="{% static 'js/st.js' %}" defer></script>

  <!-- Load Chart.js library -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="{% static 'js/chart.js' %}"></script>
{% endblock %}

{% block page %}
  <main class="mb-16 mt-1 relative flex flex-col">
    <div class="flex flex-col justify-between mb-2">
      <div class="space-y-2">
        <a class="hover:underline inline-block mr-1.5" target="_blank" href="{{ strategy.tradingview_url }}">
          <h1 class="text-left text-2xl text-title font-bold hover:underline">
            {{ strategy.name }}
            {% comment %} <svg class="h-4 w-4 ml-1 inline" stroke="currentColor" fill="currentColor" viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
              <path d="M432,320H400a16,16,0,0,0-16,16V448H64V128H208a16,16,0,0,0,16-16V80a16,16,0,0,0-16-16H48A48,48,0,0,0,0,112V464a48,48,0,0,0,48,48H400a48,48,0,0,0,48-48V336A16,16,0,0,0,432,320ZM488,0h-128c-21.37,0-32.05,25.91-17,41l35.73,35.73L135,320.37a24,24,0,0,0,0,34L157.67,377a24,24,0,0,0,34,0L435.28,133.32,471,169c15,15,41,4.5,41-17V24A24,24,0,0,0,488,0Z"></path>
            </svg> {% endcomment %}
            <span class="ml-0.5 inline-flex items-center">{% include 'strategies/include/strategy_badge.html' with type=strategy.premium %}</span>
          </h1>
        </a>

        {% if strategy.chart_url %}
          <div class="inline-block">
            <a href="#" onClick="openPopupWindow('{{ strategy.chart_url }}')" class="btn-text border-0 whitespace-nowrap">
              Live chart<svg class="h-4 aspect-auto ml-1 animate-pulse" stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 12m-1 0a1 1 0 1 0 2 0a1 1 0 1 0 -2 0"></path>
                <path d="M12 12m-5 0a5 5 0 1 0 10 0a5 5 0 1 0 -10 0"></path>
                <path d="M15.9 20.11l0 .01"></path>
                <path d="M19.04 17.61l0 .01"></path>
                <path d="M20.77 14l0 .01"></path>
                <path d="M20.77 10l0 .01"></path>
                <path d="M19.04 6.39l0 .01"></path>
                <path d="M15.9 3.89l0 .01"></path>
                <path d="M12 3l0 .01"></path>
                <path d="M8.1 3.89l0 .01"></path>
                <path d="M4.96 6.39l0 .01"></path>
                <path d="M3.23 10l0 .01"></path>
                <path d="M3.23 14l0 .01"></path>
                <path d="M4.96 17.61l0 .01"></path>
                <path d="M8.1 20.11l0 .01"></path>
                <path d="M12 21l0 .01"></path>
              </svg>
            </a>
          </div>
        {% endif %}
      </div>

      {% if strategy.premium == 'VIP' and strategy.price %}
        {% include 'strategies/include/strategy_vip_card.html' with class='mt-3' %}
      {% else %}
        {% if user.is_authenticated %}
          {% if strategy.premium == 'Free' or has_subscription %}
            {% include 'strategies/include/user_connect.html' with class='-mt-0.5' %}
          {% endif %}
        {% endif %}
      {% endif %}
    </div>

    <div class="block relative">
      <section class="backdrop-blur-2xl z-30 w-full pt-1 mb-6 relative mx-auto max-w-5xl">
        <div class="hidden absolute top-0 -left-4 bottom-0 w-8 bg-gradient-to-r from-background pointer-events-none z-10"></div>
        <div class="absolute bottom-0 top-0 right-0 w-8 bg-gradient-to-l from-background pointer-events-none z-10"></div>
        <div class="mr-auto flex justify-start gap-2 sm:gap-3 mt-2 overflow-x-auto no-scrollbar relative pr-8">
          <button id="strategyBtn" class="btn-primary text-background sm:text-base text-sm font-semibold rounded-full">
            <svg class="h-5 aspect-square mr-1" stroke="currentColor" fill="currentColor" stroke-width="2" viewBox="0 0 256 256" xmlns="http://www.w3.org/2000/svg">
              <path d="M76,152a36,36,0,1,0,36,36A36,36,0,0,0,76,152Zm0,56a20,20,0,1,1,20-20A20,20,0,0,1,76,208ZM42.34,106.34,56.69,92,42.34,77.66A8,8,0,0,1,53.66,66.34L68,80.69,82.34,66.34A8,8,0,0,1,93.66,77.66L79.31,92l14.35,14.34a8,8,0,0,1-11.32,11.32L68,103.31,53.66,117.66a8,8,0,0,1-11.32-11.32Zm187.32,96a8,8,0,0,1-11.32,11.32L204,199.31l-14.34,14.35a8,8,0,0,1-11.32-11.32L192.69,188l-14.35-14.34a8,8,0,0,1,11.32-11.32L204,176.69l14.34-14.35a8,8,0,0,1,11.32,11.32L215.31,188Zm-45.19-89.51c-6.18,22.33-25.32,41.63-46.53,46.93A8.13,8.13,0,0,1,136,160a8,8,0,0,1-1.93-15.76c15.63-3.91,30.35-18.91,35-35.68,3.19-11.5,3.22-29-14.71-46.9L152,59.31V80a8,8,0,0,1-16,0V40a8,8,0,0,1,8-8h40a8,8,0,0,1,0,16H163.31l2.35,2.34C183.9,68.59,190.58,90.78,184.47,112.83Z"></path>
            </svg>Strategy
          </button>
          <button id="performanceBtn"
            class="btn-primary text-background bg-text/10 text-text/80 sm:text-base text-sm font-semibold rounded-full {% if show_performance %} inline-flex {% else %} hidden {% endif %}">
            <svg class="w-4.5 aspect-auto mr-1" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
              <path d="M2 12H4V21H2V12ZM5 14H7V21H5V14ZM16 8H18V21H16V8ZM19 10H21V21H19V10ZM9 2H11V21H9V2ZM12 4H14V21H12V4Z"></path>
            </svg>Performance
          </button>
          <button id="settingsBtn" class="btn-primary text-background bg-text/10 text-text/80 sm:text-base text-sm font-semibold rounded-full">
            <svg class="h-4 aspect-square mr-1 fill-current" viewBox="0 0 61 79" xmlns="http://www.w3.org/2000/svg">
              <path d="M55.2164 68.871H46.5656V78.7097H39.1507V68.871H30.5L42.8582 54.1129L55.2164 68.871ZM61 34.0911L47.6532 45.8976C43.5997 49.5379 37.5194 49.6855 33.3177 46.2911L23.0851 38.125C22.3979 37.5802 21.5386 37.296 20.6604 37.323C19.7822 37.35 18.9422 37.6865 18.2901 38.2726L4.94327 50.079L0 44.6185L13.3468 32.7629C15.3149 31.0189 17.8413 30.027 20.4758 29.964C23.1103 29.9009 25.6817 30.7708 27.7318 32.4185L37.9149 40.5847C39.3485 41.7161 41.3752 41.6177 42.7099 40.4371L56.0567 28.6306L61 34.0911ZM21.8493 9.83871H30.5L18.1418 24.5968L5.78363 9.83871H14.4344V0H21.8493V9.83871Z" />
            </svg>Reports
          </button>
          <button id="commentsBtn" class="btn-primary text-background bg-text/10 text-text/80 sm:text-base text-sm font-semibold rounded-full">
            <svg class="h-5 aspect-square mr-1" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 1024 1024" fill-rule="evenodd" xmlns="http://www.w3.org/2000/svg">
              <path d="M845.784 581.585a135.867 135.867 0 0 0-47.042 19.049 114.236 114.236 0 0 1-51.41 31.075c2.613-17.554 11.313-33.577 24.455-45.418a169.303 169.303 0 0 0 23.409-55.017c-.061-27.838 22.44-50.459 50.265-50.534 27.827-.076 50.45 22.423 50.539 50.26.089 27.839-22.39 50.482-50.215 50.585zM753.568 460.83a168.829 168.829 0 0 0-54.808-23.68c-27.836 0-50.402-22.575-50.402-50.423 0-27.848 22.566-50.423 50.402-50.423 27.836 0 50.402 22.575 50.402 50.423a137.497 137.497 0 0 0 18.817 47.211 114.809 114.809 0 0 1 30.764 51.656 76.08 76.08 0 0 1-45.026-24.763h-.186zm-83.033-177.713C655.34 155.789 523.548 56.026 364.09 56.026c-169.874 0-308.088 113.097-308.088 252.19 2.72 78.1 43.941 149.778 110.063 191.385a311.284 311.284 0 0 0 33.602 21.588l-13.664 54.569c4.928 2.316 9.706 4.78 14.746 6.91l68.996-34.512c10.08 2.615 20.683 4.295 31.21 6.088 6.721 1.195 13.442 2.428 20.35 3.25a354.835 354.835 0 0 0 128.805-7.396 248.885 248.885 0 0 0 10.154 55.055 425.638 425.638 0 0 1-96.175 11.242 417.983 417.983 0 0 1-86.392-9.524l-125.186 62.526a27.619 27.619 0 0 1-29.98-3.137 28.019 28.019 0 0 1-9.67-28.611l22.401-90.239C53.176 495.186 2.463 405.506 0 308.216 0 137.973 163.004 0 364.09 0c190.93 0 347.29 124.527 362.521 282.818a244.967 244.967 0 0 0-26.47-2.614c-9.893.374-19.787 1.307-29.607 2.876zM554.237 481.934c16.764-3.362 32.706-9.786 47.042-19.049a114.236 114.236 0 0 1 51.447-31.001 76.466 76.466 0 0 1-24.491 45.344c-11.014 16.807-18.929 35.483-23.409 55.054.041 27.833-22.468 50.435-50.29 50.497-27.821.062-50.43-22.44-50.514-50.273-.082-27.833 22.393-50.469 50.215-50.572m90.798 121.314c16.652 11.168 35.17 19.236 54.659 23.904 20.386 0 38.764 12.286 46.565 31.127 7.801 18.842 3.49 40.53-10.926 54.95-14.414 14.422-36.093 18.736-54.927 10.931-18.834-7.804-31.114-26.19-31.114-46.585a136.736 136.736 0 0 0-18.668-47.285 114.714 114.714 0 0 1-30.54-51.805 76 76 0 0 1 44.951 25.062z" transform="translate(64 148)"></path>
            </svg>Comments
          </button>
        </div>
      </section>

      <section class="w-full">
        {% if strategy.premium != 'VIP' %}
          {% if not user.is_authenticated or user.is_authenticated and not has_subscription and strategy.premium != 'Free' %}
            <section class="group w-full pb-3 pt-6 nav-bg rounded sticky top-10 z-20 mb-2">
              <div class="text-center py-2">
                <h1 class="text-title/60 font-semibold text-xl mb-2">Unlock access to this strategy and more</h1>
                <h1 class="text-title/60 font-semibold text-lg mb-2">Gain access to some of the best and most powerful trading strategies in the market</h1>
                <div class="mt-4">
                  {% if not user.is_authenticated %}
                    <a href="{% url 'register' %}" class="btn-primary font-semibold whitespace-nowrap text-base">
                      Unlock access<svg class="h-6 w-6 ml-1 group-hover:scale-150 transition-transform" stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path>
                      </svg>
                    </a>
                  {% else %}
                    <button onclick="toggleGetStarted()" class="btn-primary font-semibold whitespace-nowrap text-base">
                      Unlock access<svg class="h-6 w-6 ml-1 group-hover:scale-150 transition-transform" stroke="currentColor" fill="none" stroke-width="2" viewBox="0 0 24 24" aria-hidden="true" xmlns="http://www.w3.org/2000/svg">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M15 15l-2 5L9 9l11 4-5 2zm0 0l5 5M7.188 2.239l.777 2.897M5.136 7.965l-2.898-.777M13.95 4.05l-2.122 2.122m-5.657 5.656l-2.12 2.122"></path>
                      </svg>
                    </button>
                  {% endif %}
                </div>
              </div>
            </section>
          {% endif %}
        {% endif %}

        <div id="strategyDiv" class="mx-auto max-w-5xl">
          {% if strategy.video_url %}
            <iframe class="rounded-lg w-full max-w-full aspect-video mt-2 mb-10" width="100%" height="100%" src="{{ strategy.video_url }}" title="YouTube video player" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" referrerpolicy="strict-origin-when-cross-origin" allowfullscreen></iframe>
          {% endif %}

          <div class="text-text CKEDITOR">{{ strategy.content|safe }}</div>
          {% if strategy.premium == 'VIP' and strategy.created_by.user_profile.tradingview_username %}
            <span class="text-text/50 text-xs">By <a class="font-bold hover:text-text/40 transition-colors" target="_blank" href="https://www.tradingview.com/u/{{ strategy.created_by.user_profile.tradingview_username }}/?aff_id=134591&aff_sub=134591&source=134591">@{{ strategy.created_by.user_profile.tradingview_username }}</a></span>
          {% elif strategy in user_profile.strategies.all %}
            <div class="my-3">
              <a href="mailto:issues@isalgo.com?subject=Report A BUG: {{ strategy.name }}&body=" class="inline-flex items-center text-sm text-text px-2.5 py-1 rounded-full border border-text">
                <svg class="w-4 h-4 mr-2" stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                  <path fill="none" d="M0 0h24v24H0z"></path>
                  <path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"></path>
                </svg>Report a bug
              </a>
            </div>
          {% endif %}
        </div>

        <div class="mx-auto max-w-5xl" id="performanceDiv">
          {% if show_performance %}
            {% include 'performance/include/dash/performance.html' with chart_data=chart_data overview_data=overview_data id=strategy.id broker_type='strategy' assets=assets trades=trades only_closed_trades=only_closed_trades %}
          {% endif %}
        </div>

        <div class="mx-auto max-w-5xl" id="commentsDiv">
          {% include 'include/comments.html' %}
        </div>

        <div class="mx-auto max-w-5xl" id="FullResultsDiv">
          {% include 'include/add_result.html' %}
          <div class="mt-2" id="resultsDiv">
            {% include 'include/results.html' %}
          </div>
        </div>

        <section class="my-6">
          <script type="text/javascript"></script>
        </section>
      </section>

      {% if not has_subscription %}
        {% include 'include/upgrade_modal.html' %}
      {% endif %}

      <div class="z-20 fixed bottom-6 left-1/2 -translate-x-1/2 px-3 py-1 text-xs text-background bg-text backdrop-brightness-100 rounded flex items-center" id="btns-list">
        {% include 'include/likes_results_comments.html' %}
      </div>
    </div>
  </main>

  <script type="text/javascript">
    const showCommentsBtn = document.getElementById('commentsBtn')
    const showSettingsBtn = document.getElementById('settingsBtn')
    const showStrategyBtn = document.getElementById('strategyBtn')
    const showPerformanceBtn = document.getElementById('performanceBtn')
    const commentsDiv = document.getElementById('commentsDiv')
    const settingsDiv = document.getElementById('FullResultsDiv')
    const strategyDiv = document.getElementById('strategyDiv')
    const performanceDiv = document.getElementById('performanceDiv')
    
    let cssClass = ['bg-text/10', 'text-text/80']
    
    // By default, show the settings div and hide the comments div
    strategyDiv.style.display = 'block'
    settingsDiv.style.display = 'none'
    commentsDiv.style.display = 'none'
    performanceDiv.style.display = 'none'
    
    // Add event listeners to the buttons
    showStrategyBtn.addEventListener('click', () => {
      // Show the comments div and hide the settings div
      strategyDiv.style.display = 'block'
      commentsDiv.style.display = 'none'
      settingsDiv.style.display = 'none'
      performanceDiv.style.display = 'none'
      showCommentsBtn.classList.add(...cssClass)
      showSettingsBtn.classList.add(...cssClass)
      showStrategyBtn.classList.remove(...cssClass)
      showPerformanceBtn.classList.add(...cssClass)
    })
    
    showCommentsBtn.addEventListener('click', () => {
      // Show the comments div and hide the settings div
      commentsDiv.style.display = 'block'
      settingsDiv.style.display = 'none'
      strategyDiv.style.display = 'none'
      performanceDiv.style.display = 'none'
      showCommentsBtn.classList.remove(...cssClass)
      showSettingsBtn.classList.add(...cssClass)
      showStrategyBtn.classList.add(...cssClass)
      showPerformanceBtn.classList.add(...cssClass)
    })
    
    showSettingsBtn.addEventListener('click', () => {
      // Show the settings div and hide the comments div
      settingsDiv.style.display = 'block'
      commentsDiv.style.display = 'none'
      strategyDiv.style.display = 'none'
      performanceDiv.style.display = 'none'
    
      showCommentsBtn.classList.add(...cssClass)
      showStrategyBtn.classList.add(...cssClass)
      showSettingsBtn.classList.remove(...cssClass)
      showPerformanceBtn.classList.add(...cssClass)
    })
    
    showPerformanceBtn.addEventListener('click', () => {
      // Show the settings div and hide the comments div
      performanceDiv.style.display = 'block'
      commentsDiv.style.display = 'none'
      strategyDiv.style.display = 'none'
      settingsDiv.style.display = 'none'
    
      showCommentsBtn.classList.add(...cssClass)
      showStrategyBtn.classList.add(...cssClass)
      showSettingsBtn.classList.add(...cssClass)
      showPerformanceBtn.classList.remove(...cssClass)
    })
    
    showStrategyBtn.click()
    
    function showResults(resultParam) {
      const showCommentsBtn = document.getElementById('settingsBtn')
      showCommentsBtn.click()
      if (resultParam) {
        scrollToResultOrComment('result', resultParam)
    
        //const performanceBtn = document.getElementById('result-perfermance-' + resultParam)
        //if (performanceBtn) performanceBtn.click()
      } else scrollToResultOrComment('resultsDiv')
    }
    
    function showComments(commentParam) {
      const showCommentsBtn = document.getElementById('commentsBtn')
      showCommentsBtn.click()
      if (commentParam) scrollToResultOrComment('comment', commentParam)
      else scrollToResultOrComment('commentsDiv')
    }
    
    function showPerformances() {
      const showPerformanceBtn = document.getElementById('performanceBtn')
      showPerformanceBtn.click()
      scrollToResultOrComment('performanceDiv')
    }
    
    function showStrategy() {
      const showStrategyBtn = document.getElementById('strategyBtn')
      showStrategyBtn.click()
      scrollToResultOrComment('strategyDiv')
    }
    
    window.addEventListener('load', function () {
      const urlParams = new URLSearchParams(window.location.search)
      const resultParam = urlParams.get('report')
    
      if (resultParam) {
        showResults(resultParam)
      }
    
      const commentParam = urlParams.get('comment')
    
      if (commentParam) {
        showComments(commentParam)
      }
    })
  </script>

  {% comment %}XLSX results{% endcomment %}
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  {% if congrate %}
    {% include 'include/congrate.html' %}
  {% endif %}
{% endblock %}
