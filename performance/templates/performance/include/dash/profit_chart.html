{% load custom_tags %}
<div id="profit-chart-container-{{cid}}" class="w-full">
    <div class="relative mb-4">
        <div class="hidden absolute top-0 -left-4 bottom-0 w-8 bg-gradient-to-r from-background pointer-events-none z-10"></div>
        <div class="absolute bottom-0 top-0 right-0 w-8 bg-gradient-to-l from-background pointer-events-none z-10"></div>
        <div id="currencies-btns-{{cid}}" class="flex items-center gap-3 overflow-x-auto no-scrollbar pr-8">
            {% for currency, info in data.items %}
            <button data-currency="{{currency}}" data-cid="{{cid}}" data-chart-data='{{info.data|to_json}}' data-profit="{{info.cumulative.net_profit}}" class="currency-btn-{{cid}} px-4 py-1 text-sm font-semibold rounded-full border-transparent border {% if info.cumulative.net_profit >= 0 %}text-profit bg-profit/20{% else %}text-loss bg-loss/20{% endif %}">{{ currency }}</button> 
            {% endfor %}
        </div>
    </div>
    <div class="w-full">
        {% for currency, curr_perf in currencies_performance.items %}
            {% with info=data|get_item:currency %}
                <div id="pnl-cards-{{currency}}-{{cid}}" class="relative w-full hidden">
                    <div class="hidden absolute top-0 -left-4 bottom-0 w-8 bg-gradient-to-r from-background pointer-events-none z-10"></div>
                    <div class="absolute bottom-0 top-0 right-0 w-8 bg-gradient-to-l from-background pointer-events-none z-10"></div>

                    <div class="flex items-start gap-4 w-full overflow-x-auto no-scrollbar pr-8">
                        {% include 'include/dash/perf_card.html' with title='Trades' value=curr_perf.trades label1='Buy' val1=curr_perf.buy_trades label2='Sell' val2=curr_perf.sell_trades %}
                        {% include 'include/dash/perf_card.html' with title='Net PnL' value=curr_perf.net_profit|floatformat:8|trim_zeros|default:'0' v_color="auto" label1='PnL' val1=curr_perf.profit|floatformat:8|trim_zeros|default:'0' v1_color="auto" label2='Today net PnL' val2=info.today_net_profit|floatformat:8|trim_zeros|default:'0' v2_color="auto" %}
                        {% include 'include/dash/perf_card.html' with title='Profit factor' value=curr_perf.profit_factor|floatformat:2|default:'0' label1='Buy' val1=curr_perf.buy_profit_factor|floatformat:2|default:'0' label2='Sell' val2=curr_perf.sell_profit_factor|floatformat:2|default:'0' %}
                        {% include 'include/dash/perf_card.html' with title='Days traded' value=info.number_of_days label1='Avg Trades' val1=info.avg_daily_trades|floatformat:0|default:'0' label2='Avg net PnL' val2=info.avg_daily_net_profit|floatformat:8|trim_zeros|default:'0' v2_color="auto" %}
                    </div>
                </div>
            {% endwith %}
        {% endfor %}
        <div class="relative w-full !h-80 md:!h-96 mt-4">
            <canvas id="accountProfitChart-{{ id }}-{{cid}}" class="!w-full !h-full bg-transparent backdrop-blur-3xl rounded-lg"></canvas>
        </div>


        {% for currency, info in currencies_performance.items %}
            <div id="perf-table-{{currency}}-{{cid}}" class="hidden mt-6 w-full ih-96 overflow-auto no-scrollbar">
                <h6 class="text-title/80 text-sm font-semibold bg-text/10 rounded-md py-2 px-2">Details</h6>
                {% include 'include/dash/perf_table.html' with perf=info %}
            </div>
        {% endfor %}

    </div>
</div>
<script type="text/javascript">
(function() {
    // Scoped variables for this specific chart instance
    const chartId = '{{ id }}-{{cid}}';
    const cid = '{{cid}}';
    const container = document.getElementById('profit-chart-container-{{cid}}');
    const buttonsContainer = document.getElementById('currencies-btns-{{cid}}');
    const buttons = buttonsContainer ? buttonsContainer.querySelectorAll('.currency-btn-{{cid}}') : [];
    
    const pnlCardsContainers = {
        {% for currency, info in data.items %}
            '{{currency}}-{{cid}}': document.getElementById('pnl-cards-{{currency}}-{{cid}}'),
        {% endfor %}
    };

    const perfTables = {
        {% for currency, info in data.items %}
            '{{currency}}-{{cid}}': document.getElementById('perf-table-{{currency}}-{{cid}}'),
        {% endfor %}
    };

    function currencyBtnClicked(currencyId, profit) {
        buttons.forEach(function(btn) {
            const btnCurrencyId = btn.dataset.currency + '-' + btn.dataset.cid;
            if(btnCurrencyId === currencyId) {
                btn.classList.remove('border-transparent');
                if(profit >= 0) {
                    btn.classList.add('border-profit');
                } else {
                    btn.classList.add('border-loss');
                }
                if(pnlCardsContainers[currencyId]) {
                    pnlCardsContainers[currencyId].classList.remove('hidden');
                    pnlCardsContainers[currencyId].classList.add('block');
                }
                if(perfTables[currencyId]) {
                    perfTables[currencyId].classList.remove('hidden');
                }
            } else {
                btn.classList.remove('border-profit', 'border-loss');
                btn.classList.add('border-transparent');
                if(pnlCardsContainers[btnCurrencyId]) {
                    pnlCardsContainers[btnCurrencyId].classList.add('hidden');
                    pnlCardsContainers[btnCurrencyId].classList.remove('block');
                }
                if(perfTables[btnCurrencyId]) {
                    perfTables[btnCurrencyId].classList.add('hidden');
                }
            }
        });
    }

    function handleButtonClick(event) {
        event.preventDefault();
        const btn = event.currentTarget;
        const currency = btn.dataset.currency;
        const currencyId = currency + '-' + btn.dataset.cid;
        const profit = parseFloat(btn.dataset.profit);
        let chartData;
        try {
            chartData = JSON.parse(btn.dataset.chartData);
        } catch(e) {
            console.error('Failed to parse chart data:', e);
            return;
        }
        
        currencyBtnClicked(currencyId, profit);
        loadAccountProfitCharts(chartId, chartData);
    }

    // Attach click handlers to buttons
    buttons.forEach(function(btn) {
        btn.addEventListener('click', handleButtonClick);
    });

    // Auto-click first button
    function autoClickFirstButton() {
        if (buttons.length > 0) {
            buttons[0].click();
        }
    }
    
    // For HTMX loaded content, run immediately since DOM is already ready
    // For initial page load, wait for DOMContentLoaded if needed
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', autoClickFirstButton);
    } else {
        // Use setTimeout to ensure canvas is rendered
        setTimeout(autoClickFirstButton, 0);
    }
})();
</script>