{% load custom_tags %}
{% load custom_filters %}
<div id="profit-chart-container-{{cid}}" class="w-full ">
    {# Currency Tabs - Scrollable #}
    <div class="relative mb-4">
        <div class="absolute bottom-0 top-0 right-0 w-8 bg-gradient-to-l from-background pointer-events-none z-10"></div>
        <div id="currencies-btns-{{cid}}" class="flex flex-nowrap items-center gap-2 overflow-x-auto no-scrollbar pr-8">
            {% for currency, info in data.items %}
                {% with currency_info=currencies_performance|get_item:currency %}
                    <button 
                        data-currency="{{currency}}" 
                        data-cid="{{cid}}" 
                        data-chart-data='{{info.data|to_json}}' 
                        data-chart-structure-data='{{currency_info|to_json}}'
                        data-profit="{{info.cumulative.net_profit}}"
                        class="currency-btn-{{cid}} flex-shrink-0 px-3 py-1.5 text-xs font-medium rounded-lg transition-all bg-text/5 text-text/60 "
                    >
                        {{ currency }}
                        <span class="ml-1 {{info.cumulative.net_profit|profit_color}}">
                            {% if info.cumulative.net_profit >= 0 %}+{% endif %}{{ info.cumulative.net_profit|floatformat:2|trim_zeros }}
                        </span>
                    </button> 
                {% endwith %}
            {% endfor %}
        </div>
    </div>
    
    {# Stats Cards per Currency - Scrollable #}
    {% for currency, curr_perf in currencies_performance.items %}
        {% with info=data|get_item:currency %}
            <div id="pnl-cards-{{currency}}-{{cid}}" class="pnl-cards-{{cid}} hidden relative w-full mb-4">
                <div class="absolute bottom-0 top-0 right-0 w-8 bg-gradient-to-l from-background pointer-events-none z-10"></div>
                <div class="flex flex-nowrap items-stretch gap-3 overflow-x-auto no-scrollbar pr-8">
                    <div class="flex-shrink-0 bg-text/5 rounded-lg p-3 min-w-[220px]">
                        <span class="text-xs text-text/50">Trades</span>
                        <p class="text-lg font-bold text-text/80">{{ curr_perf.trades }}</p>
                    </div>
                    <div class="flex-shrink-0 bg-text/5 rounded-lg p-3 min-w-[220px]">
                        <span class="text-xs text-text/50">Net Profit</span>
                        <p class="text-lg font-bold {{curr_perf.net_profit|profit_color}}">
                            {% if curr_perf.net_profit >= 0 %}+{% endif %}{{ curr_perf.net_profit|floatformat:4|trim_zeros }}
                        </p>
                    </div>
                    <div class="flex-shrink-0 bg-text/5 rounded-lg p-3 min-w-[220px]">
                        <span class="text-xs text-text/50">Max Profit</span>
                        <p class="text-lg font-bold text-profit">+{{ info.max_net_profit|floatformat:4|trim_zeros }}</p>
                    </div>
                    <div class="flex-shrink-0 bg-text/5 rounded-lg p-3 min-w-[220px]">
                        <span class="text-xs text-text/50">Max Drawdown</span>
                        <p class="text-lg font-bold text-loss">{{ info.max_drawdown|floatformat:4|trim_zeros }}</p>
                    </div>
                    <div class="flex-shrink-0 bg-text/5 rounded-lg p-3 min-w-[220px]">
                        <span class="text-xs text-text/50">Profit Factor</span>
                        <p class="text-lg font-bold {% if curr_perf.profit_factor >= 1 %}text-profit{% else %}text-loss{% endif %}">{{ curr_perf.profit_factor|floatformat:2|default:'0' }}</p>
                    </div>
                    <div class="flex-shrink-0 bg-text/5 rounded-lg p-3 min-w-[220px]">
                        <span class="text-xs text-text/50">Days Traded</span>
                        <p class="text-lg font-bold text-text/80">{{ info.number_of_days|default:'0' }}</p>
                    </div>
                </div>
            </div>
        {% endwith %}
    {% endfor %}
    
    {# Chart Canvas #}
    <div class="relative w-full h-72 md:h-80">
        <canvas id="accountProfitChart-{{ id }}-{{cid}}" class="!w-full !h-full bg-transparent backdrop-blur-3xl rounded-lg"></canvas>
    </div>
    
    
    {# Average Stats per Currency #}
    {% for currency, curr_perf in currencies_performance.items %}
        {% with info=data|get_item:currency %}
            <div id="avg-stats-{{currency}}-{{cid}}" class="avg-stats-{{cid}} hidden mt-4 flex flex-wrap gap-4 text-xs">
                <div class="flex items-center gap-2">
                    <span class="text-text/50">Avg Daily Profit:</span>
                    <span class="font-medium {{info.avg_daily_net_profit|profit_color}}">
                        {{ info.avg_daily_net_profit|floatformat:4|trim_zeros|default:'0' }}
                    </span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-text/50">Avg Daily Trades:</span>
                    <span class="font-medium text-text/80">{{ info.avg_daily_trades|floatformat:0|default:'0' }}</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-text/50">Today's P/L:</span>
                    <span class="font-medium {{info.today_net_profit|profit_color}}">
                        {{ info.today_net_profit|floatformat:4|trim_zeros|default:'0' }}
                    </span>
                </div>
            </div>
        {% endwith %}
    {% endfor %}



    <div class="relative mt-10 mb-4 grid grid-cols-1 md:grid-cols-2 gap-8">
        <div class="relative">
            <h4 class="text-sm sm:text-base font-semibold text-title/80 mb-4">Profit structure</h4>
            <div class="relative h-72 md:h-80">
                <canvas id="accountProfitStructureChart-{{ id }}-{{cid}}" class="!w-full !h-full bg-transparent backdrop-blur-3xl rounded-lg"></canvas>
            </div>
            <div class="mt-3 flex items-center justify-center gap-4 text-xs text-text/60">
                <div class="flex items-center gap-2">
                    <span class="w-2 aspect-square rounded-full bg-profit"></span>
                    <span>Profit</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-2 aspect-square rounded-full bg-loss"></span>
                    <span>Loss</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-2 aspect-square rounded-full bg-text/60"></span>
                    <span>Fees</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-2 aspect-square rounded-full bg-primary"></span>
                    <span>Net</span>
                </div>
            </div>
        </div>

        <div class="relative">
            <h4 class="text-sm sm:text-base font-semibold text-title/80 mb-4">Buy vs Sell</h4>
            <div class="relative h-72 md:h-80">
                <canvas id="accountProfitRadar-{{ id }}-{{cid}}" class="!w-full !h-full bg-transparent backdrop-blur-3xl rounded-lg"></canvas>
            </div>
            <div class="mt-3 flex items-center justify-center gap-4 text-xs text-text/60">
                <div class="flex items-center gap-2">
                    <span class="w-2 aspect-square rounded-full bg-profit"></span>
                    <span>Profit</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-2 aspect-square rounded-full bg-text/80"></span>
                    <span>Fees</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-2 aspect-square rounded-full bg-primary"></span>
                    <span>Net</span>
                </div>
            </div>
        </div>
    </div>

    {# Details Table per Currency #}
    {% for currency, info in currencies_performance.items %}
        <div id="perf-table-{{currency}}-{{cid}}" class="perf-table-{{cid}} hidden mt-6 w-full overflow-auto no-scrollbar">
            <h6 class="text-title/80 text-sm font-semibold bg-text/10 rounded-md py-2 px-2">Details</h6>
            {% include 'include/dash/perf_table.html' with perf=info %}
        </div>
    {% endfor %}
</div>

<script type="text/javascript">
(function() {
    const chartId = '{{ id }}-{{cid}}';
    const cid = '{{cid}}';
    const container = document.getElementById('profit-chart-container-{{cid}}');
    const buttonsContainer = document.getElementById('currencies-btns-{{cid}}');
    const buttons = buttonsContainer ? buttonsContainer.querySelectorAll('.currency-btn-{{cid}}') : [];
    
    function switchTab(btn, chartData, chartStructureData) {
        const currency = btn.dataset.currency;
        const currencyId = currency + '-' + cid;
        const profit = parseFloat(btn.dataset.profit);
        
        // Update tab styles
        buttons.forEach(t => {
            t.classList.remove('bg-profit/20', 'bg-loss/20', 'text-text');
            t.classList.add('bg-text/5', 'text-text/60');
        });
        btn.classList.remove('bg-text/5', 'text-text/60');
        if(profit >= 0)
            btn.classList.add('bg-profit/20', 'text-text');
        else
            btn.classList.add('bg-loss/20', 'text-text');
        
        // Show/hide pnl cards
        container.querySelectorAll('.pnl-cards-{{cid}}').forEach(el => el.classList.add('hidden'));
        const pnlCards = document.getElementById('pnl-cards-' + currencyId);
        if (pnlCards) pnlCards.classList.remove('hidden');
        
        // Show/hide avg stats
        container.querySelectorAll('.avg-stats-{{cid}}').forEach(el => el.classList.add('hidden'));
        const avgStats = document.getElementById('avg-stats-' + currencyId);
        if (avgStats) avgStats.classList.remove('hidden');
        
        // Show/hide perf tables
        container.querySelectorAll('.perf-table-{{cid}}').forEach(el => el.classList.add('hidden'));
        const perfTable = document.getElementById('perf-table-' + currencyId);
        if (perfTable) perfTable.classList.remove('hidden');
        
        // Update chart
        if (typeof loadAccountProfitCharts === 'function') {
            loadAccountProfitCharts("accountProfitChart-" + chartId, chartData);
            if (typeof loadAccountProfitStructureCharts === 'function') {
                loadAccountProfitStructureCharts("accountProfitStructureChart-" + chartId, chartStructureData);
                if (typeof loadPerformanceRadarChart === 'function') {
                    loadPerformanceRadarChart("accountProfitRadar-" + chartId, chartStructureData);
                } else if (typeof loadBuySellRadarChart === 'function') {
                    loadBuySellRadarChart("accountProfitRadar-" + chartId, chartStructureData, chartStructureData);
                }
            }
        }
    }

    function handleButtonClick(event) {
        event.preventDefault();
        const btn = event.currentTarget;
        let chartData;
        let chartStructureData;
        try {
            chartData = JSON.parse(btn.dataset.chartData);
            chartStructureData = JSON.parse(btn.dataset.chartStructureData);
        } catch(e) {
            console.error('Failed to parse chart data:', e);
            return;
        }
        switchTab(btn, chartData, chartStructureData);
    }

    // Attach click handlers to buttons
    buttons.forEach(function(btn) {
        btn.addEventListener('click', handleButtonClick);
    });

    // Auto-click first button
    function autoClickFirstButton() {
        if (buttons.length > 0) {
            buttons[0].click();
        }
    }
    
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', autoClickFirstButton);
    } else {
        setTimeout(autoClickFirstButton, 0);
    }
})();
</script>
